# ESP32 Train Schedule Viewer

ESP32を使用して電車の運行情報（時刻表・遅延情報）をリアルタイム表示するデバイスのプロジェクトです。

---

## 概要

ESP32にOLEDディスプレイとボタンを接続し、Wi-Fi経由でNAVITIMEのHTMLを取得・解析し、乗り換え案内や遅延情報を表示します。  
NTPサーバーで時刻を同期し、ボタン操作で路線や時刻表を切り替えることができます。

また、

- バッテリー監視機能
- 非アクティブ時のディープスリープによる省電力化

も実装されています。

---

## 動作イメージ

ESP32 + OLED による実際の表示例です。

<p align="center">
  <img width="600"
       alt="ESP32 Train Schedule Viewer Display"
       src="https://github.com/user-attachments/assets/a75b6948-8ec5-4779-affa-84e620b59309">
</p>

表示内容：

- 現在時刻
- 選択中の路線
- 次の電車の出発時刻
- 遅延・運転見合わせ情報
- バッテリー残量

---

## 主な機能

### Wi-Fi接続
指定されたSSIDとパスワードでWi-Fiネットワークに接続します。

### 時刻同期
NTPサーバーから正確な時刻を取得し、内部時計を同期します。

### 乗り換え案内表示
- 定義された複数の路線（駅間）の情報をNAVITIMEから取得
- ボタン操作で表示路線を切り替え
- 次の電車の発車時刻を表示

### 遅延・運転見合わせ情報表示
路線情報取得時に遅延や運転見合わせが発生している場合、その情報を抽出してOLEDに表示します。

### ディスプレイ制御
- `Arduino_GFX` ライブラリを使用
- ESP32 QSPI接続OLEDに描画

### ボタン操作
- **短押し**：次の路線へ切り替え  
- **長押し（1秒以上）**：次の電車（インデックス）へ切り替え  

### バッテリー監視
- GPIO4（`BAT_PIN`）でADC読み取り
- 電圧からおおよその残量（%）を計算して表示

### 省電力機能
約2分間操作がない場合：

- ディスプレイをオフ
- ESP32をディープスリープへ移行

---

## ファイル構成

- `main.ino`  
  Wi-Fi接続、NTP同期、LCD表示、ボタン処理、HTML取得とパース処理を含むメインプログラム

- `pin_config.h`  
  ESP32の各ピン定義（LCD、ボタン、バッテリーADCなど）

- `README.md`  
  プロジェクト説明ファイル

---

## セットアップと実行方法

### 1. 必要なライブラリのインストール

以下のライブラリをインストールしてください。

- `Arduino_GFX_Library`
- `WiFi`
- `HTTPClient`
- `WiFiClientSecure`
- `time`

（必要に応じて）
- `ArduinoJson`

Arduino IDE のライブラリマネージャからインストール可能です。

---

### 2. main.ino の設定

以下を環境に合わせて変更してください。

- `ssid`
- `password`
- `serverURLs[]`
- `routeLabels[]`

---

### 3. ESP32への書き込み

Arduino IDE または PlatformIO を使用して書き込みます。

`pin_config.h` 内のディスプレイマクロ：

- `DO0143FMST10`
- `DO0143FAT01`

が使用しているOLEDと一致していることを確認してください。

---

### 4. 動作確認

- 起動後、Wi-Fiに接続
- 時刻同期
- OLEDに時刻・路線情報を表示
- ボタンで路線・時刻表を切り替え可能
- 無操作でディープスリープへ移行

---

## 開発者

**Mizuki**
