# ESP32 Train Schedule Viewer

このリポジトリは、ESP32を使用して電車の運行情報（時刻表、遅延情報）をリアルタイムに表示するデバイスのソースコードを含んでいます。

## 概要
ESP32にOLEDディスプレイとボタンを接続し、Wi-Fi経由でNAVITIMEのHTMLを取得し、パースした情報から乗り換え案内や遅延情報を取得して表示します(少しグレー？)。NTPサーバーで時刻を同期し、ボタン操作で路線や時刻表を切り替えることができます。また、バッテリー監視機能と、非アクティブ時のディープスリープ機能による省電力化も実装されています。

## 機能
*   **Wi-Fi接続:** 指定されたSSIDとパスワードでWi-Fiネットワークに接続します。
*   **時刻同期:** NTPサーバーから正確な時刻を取得し、表示します。
*   **乗り換え案内表示:** 
    *   定義された複数の路線（駅間）の乗り換え案内をNAVITIMEのウェブページから取得します。
    *   ボタン操作（短押し・長押し）で、表示する路線や時刻表を切り替えることができます。
    *   選択された路線の次の電車時刻表を表示します。
*   **遅延・運転見合わせ情報:** 
    *   路線情報取得時に、遅延や運転見合わせが発生している場合、その旨を（URLから抽出）をOLEDディスプレイに表示します。
*   **LCDディスプレイ表示:** 
    *   Arduino_GFXライブラリを使用し、ESP32 QSPIインターフェースに接続されたOLEDディスプレイに情報を表示します。
    *   現在の時刻、選択中の路線、次の電車の出発時刻、遅延情報などを表示します。
    *   バッテリー電圧と残量（%）も表示します。
*   **ボタン操作:** 
    *   短押し: 次の路線へ切り替え。
    *   長押し (1秒以上): 次の電車の時刻表（index指定）に切り替え。
*   **バッテリー監視:** 
    *   ESP32のGPIOピン4 (BAT_PIN) に接続されたバッテリー電圧をADCで読み取り、おおよその残量（%）を表示します。
*   **省電力機能:** 
    *   一定時間（約2分）操作がない場合、LCDディスプレイをオフにしてESP32をディープスリープモードに移行させます。

## ファイル構成
*   `main.ino`: プログラムのメインファイル。Wi-Fi接続、NTP同期、LCD表示、ボタン処理、NAVITIMEのHTMLからのデータ取得と表示ロジックが含まれます。
*   `pin_config.h`: ESP32の各ピン（LCD、Wi-Fi、ボタン、バッテリーADCなど）の定義が記載されています。
*   `README.md`: このファイル。プロジェクトの概要、機能、セットアップ方法などを記述します。

## セットアップと実行方法
1.  **必要なライブラリのインストール:** 
    *   `Arduino_GFX_Library.h` (ディスプレイ制御用)
    *   `WiFi.h` (Wi-Fi接続用)
    *   `HTTPClient.h` (HTTPリクエスト用)
    *   `WiFiClientSecure.h` (HTTPSリクエスト用)
    *   `time.h` (時刻同期用)
    *   （必要に応じて）`ArduinoJson.h` (JSONパース用)

    これらのライブラリは、Arduino IDE のライブラリマネージャからインストールするか、手動で追加してください。

2.  **`main.ino` の設定:** 
    *   `ssid` と `password`: ご利用のWi-Fiネットワーク名とパスワードに置き換えてください。
    *   `serverURLs[]` と `routeLabels[]`: 必要に応じて、表示したい路線や駅の情報を更新してください。

3.  **ESP32へのプログラム書き込み:** 
    *   Arduino IDE や PlatformIO などの開発環境を使用し、ESP32ボードに `main.ino` を書き込みます。
    *   `pin_config.h` で定義されているディスプレイのマクロ (`DO0143FMST10` または `DO0143FAT01`) が、お使いのOLEDに合わせて正しく選択されていることを確認してください。

4.  **動作確認:** 
    *   ESP32が起動し、Wi-Fiに接続されると、OLEDディスプレイにトレインスケジュールビューアが表示され、時刻と路線情報が更新されます。
    *   ボタンを押して、表示する路線や時刻表を切り替えることができます。
    *   操作がない場合、ディスプレイが消灯し、ESP32はディープスリープモードに入ります。

**開発者:** Mizuki

---
